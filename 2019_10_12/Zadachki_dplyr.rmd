---
title: "dplyr_task"
author: "Dimvdali"
date: "09 10 2019"
output: html_document
---

```{r}
library(tidyverse, type = "binary") # использовать базовую версию пакета
library(lubridate)
```


```{r}
#data18 = read.csv2("data_2018.csv")
data18_s = read.csv2("data18_short.csv", encoding = "UTF-8")
#data17 = read.csv2("data_2017.csv")
data17_s = read.csv2("data17_short.csv", encoding = "UTF-8")
```

select()
Выберите c 2 по 4 колонки в данных data17_s
```{r}
data17_s %>% 
  select(2:4)
```

Выберите в данных data17_s колонки, связанные с описанием аварии (crash)
```{r}
data17_s %>% 
  select(contains("crash"))
```

filter()
Выбрать в данных только те аварии, где есть пострадавшие
```{r}
data17_s %>% 
  select() %>% 
  filter()
```

1.2. Выбрать в данных только аварии по типам (crash_type_name) "Столкновение" и "Опрокидывание"
```{r}
data17_s %>% 
  filter()
```

count()
Вопрос: Сколько произошло аварий по этим типам?
```{r}
data17_s %>% 
  filter() %>% 
  count()
```

top_n / slice() / head() / tail()
Вопрос: Сколько было аварий в каждом из регионов? Показать первые 5 строчек по количеству ДТП
```{r}
data17_s %>% 
  select() %>% 
  count() %>% 
  head()
```

Вопрос: Сколько было аварий в каждом из регионов? Показать последние 8 строчек по количеству ДТП
```{r}
data17_s %>% 
  select() %>% 
  count() %>% 
  tail()
```

arrange()

Вопрос: Где больше всего аварий? Показать ТОП-3
```{r}
data17_s %>% 
  select() %>% 
  count() %>%
  arrange() %>% 
  top_n()
```

Вопрос: А в где меньше всего? Показать ТОП-3
```{r}
data17_s %>% 
  select() %>% 
  count() %>%
  arrange() %>% 
  tail()
```

А ТЕПЕРЬ ВСЕ ВМЕСТЕ!

Выбрать колонки, связанные с причиненным ущербом (машины/люди) и колонку с названием регионов. Выбрать только те случаи, где в ДТП участвовало от 3 до 8 транспортных средств (vehicles_amount) включительно. Сколько было аварий с участием каждого из количеств машин? 

Вопрос: Сколько было случаев, когда в ДТП участвовало 6 машин?

```{r}
data17_s %>% 
  select() %>% 
  filter() %>% 
  count()
```

*Задание со звездочкой:*
Сделать все то же самое, но отфильтровать еще и по областям. Другими словами, reg_name должен содержать только области.
(see grepl())

```{r}
data17_s %>% 
  select() %>% 
  filter() %>% 
  filter() %>% 
  count()
```


summarize(
mean(),
max().
...
)
Вопросы: (отобразить все ответы одной выдачей)
Сколько в среднем участвует машин в ДТП? Округлить до целого числа
А какое медианное число?
Сколько всего машин попало в ДТП за 2017 год?
Сколько максимум и минимум машин попадало в ДТП в 2017 году?
```{r}
data17_s %>% 
  select(reg_name, vehicles_amount) %>% 
  summarise(
    
  ) 
```

group_by()

Вопрос: Сколько машин попадают в ДТП по регионам?
```{r}
data17_s %>% 
  select(reg_name, vehicles_amount) %>% 
  group_by() %>%  
  summarise(
    
  )
```


Вопрос: Сколько было аварий с участием 5 машин в Владимирской области в 2017 году?
```{r}
  
```


Вопрос: Сколько машин в среднем попадает в ДТП по регионам? (Округлить до целого числа); Сколько регионов, в которых в среднем в ДТП участвует больше 1 машины?
```{r}

```

mutate()

Создать переменную "счастливчики" - ребята, которые попали в ДТП, но не пострадали
```{r}
data17_s %>% 
  select(reg_name, contains("amount")) %>% 
  mutate(happy = )
```

Вопрос: А есть такие случаи, что в данных ошибка и пострадавших больше, чем участников? (счастливчиков отрицательное число)
Как это можно объяснить?
```{r}

```

*Задачка со звездочкой*

Шок контент: немного статистики! Есть ли связь между количеством машин и количеством счастливчиков?
```{r}
test = data17_s %>% 
  select() %>% 
  mutate(happy = )
```

```{r}

```


join()

дальше попробуем работать и с 2017 и с 2018 годом. Надо объединить 2 датасета...
```{r}
#data_full = inner_join(data17_s, data18_s, by = "reg_name") #это бредово
data_full = rbind(data17_s, data18_s)
```

но!
Симуляции)))
```{r}
id = c("a", "b", "c")
id2 = c("a", "b", "a")
a = c(1:3)
b = c(4:6)
d = c(7:9)


data1 = data.frame(id = id2, v1 = a)
data2 = data.frame(id = id, v2 = b, v3 = d)
```

```{r}
df_f = full_join(data1, data2, by = "id") #полное соединение
df_f
df_i = inner_join(data1, data2, by = "id") #соединяем только те элементы по которым есть совпадение
df_i
df_r = right_join(data1, data2, by = "id") #когда важнее элементы, которые нахлдятся в первом датасете
df_r
df_l = left_join(data1, data2, by = "id") #когда важнее элементы, которые нахлдятся во втором датасете
df_l
```

pivot_longer() / pivot_wider()


Но сначала немного lubridate!

```{r}
data_full$crash_date = ymd(data_full$crash_date)
```

Подготовим детали
Нужно создать переменную год, которая будет дублировать переменную crash_date, но будет округлена до года: round_date()
Проверьте, точно ли у нас 64693	наблюдений по 2017 году и 20424	по 2018
```{r}

```


Задача: показать динамику количества ДТП с 2017 по 2018 в региональном разрезе. Если общий тренд? Это относится ко всем регионам?

1) Посмотрим, сколько было ДТП в регионах в 2017 и 2018 годах
```{r}

```

2) Попробуйте это нарисовать
```{r}

```

Общая картинка ясна. Но это относится прям ко всем регионам или есть места, которые не поддались общей динамике?
Кстати, какие есть идеи по поводу того, что видим?

3) Создать переменную в которой будет разница между количеством ДТП в 2017 и 2018 годах и проранжируем, чтобы понять, есть ли отрицательные значения
```{r}

```




Какие еще вопросы можно задать...?

*задачки со звездочкой*
Вопрос: Какая динамика по месяцам? (Какой месяц самый неприятный и топ по количеству ДТП)
Вопрос: Вопрос: Какие типы ДТП самые частые? Как они распределены по регионам? Выберите 3 типа и постройте оба формата данных. Визуализируйте ТОП-5 получившихся данных